<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css">
    <title>Document</title>
</head>

<body>
    <!-- <button id='connect' onclick="createToken()">CREATE</button> -->
    <div id="peer_id"></div>

    <input type="text" id="con_id" />
    <button id='send' onclick="connect()">connect</button>

    <div id="chat" class="d-none">
        <input type="text" id="messagge" />
        <button id='send' onclick="sendMessage()">send message</button>
        <table class="table table-bordered" id="childTable" class="d-none">
            <thead class="table-info">
              <tr>
                <th scope="col">You</th>
                <th scope="col">Other</th>
              </tr>
            </thead>
            <tbody>
            </tbody>
        </table>
    </div>
    

</body>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/peerjs/1.3.2/peerjs.js" integrity="sha512-Us7lczoIk7ihPZfJ7UgbG8jQU/oK7NnpbXisL+t3WSv3GDokuzMOwfMAwIzPMuF3SPfKoJYUw80Y7moQkID+7A==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script>
    //for both
    let peer = new Peer();//peer object manage RTC connection
    let peer_id = null; //id of peer object
    let another_peer_id = null; //id of peer on another side
    let is_connected = 0;//boolean to know is peer connected with another peer
    let conn; //variable for connection object
    peer.on('open', function (id) {
        console.log('My peer ID is: ' + id);
        peer_id = id; //assigning value to peer id
        document.getElementById('peer_id').innerHTML = id;  
    });
    peer.on('connection', function (con) {        
        con.on('data', function (data) {
            console.log("We received :");
            console.log(data);
            if(data.peer_id){   
                another_peer_id = data.peer_id;
            }
            if(!is_connected){
                conn = peer.connect(another_peer_id);
                conn.on('open', function (data) {
                    document.querySelector('#chat').classList.remove('d-none');
                    is_connected =1;
                    conn.send({
                        "peer_id":peer_id
                    });
                });
            }
            if(data.message){
                childrenRow("",data.message);
            }
        });
    });
    
    const connect = () =>{
        conn = peer.connect(document.getElementById('con_id').value);        
        conn.on('open', function (data) {
            document.querySelector('#chat').classList.remove('d-none');
            is_connected =1;
            conn.send({
                "peer_id":peer_id
            });
        });
    }
    

    const sendMessage = () =>{
        let message = document.getElementById('messagge').value;
        conn.send({
            "message":message
        });
        childrenRow(message,"");
    }



    
    function childrenRow(mine, another) {
        $('#childTable').find('tbody').append(`
            <tr>
                <td class="col-sm-4">
                    <input type="text" name="name" class="form-control" value="${mine}"/>
                </td>
                <td class="col-sm-2">
                    <input type="text" name="year" class="form-control" value="${another}"/>
                </td>
            </tr>`
        );
    }

    // let conn;
    // const connect = () => {
    //     conn = peer.connect(document.getElementById('con_id').value);
    //     console.log('here' + conn);
    // }
    // const sendMessage = () => {

    //     // on open will be launch when you successfully connect to PeerServer
    // conn.on('open', function (data) {
    //     // Receive messages
    //     conn.on('data', function (data) {
    //         console.log('Received', data);
    //     });
    // });

    //     conn.send(document.getElementById('message').value);
    // }

</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.min.js"></script>
</html>